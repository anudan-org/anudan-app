<div class="row anu-container">

  <div class="col-12 bg-white" style="position: sticky;top: 20px;z-index: 1040;">
    <span class="badge badge-success pull-right">{{currentGrant.grantStatus.displayName}}</span>
    <div class="row">
    <div class="col-2 text-right">
      <a *ngIf="canManage" mat-stroked-button (click)="addNewSection()" >
        <mat-icon>add_box</mat-icon>Add new Section</a>
    </div>
    </div>
  </div>


  <div class="col-lg-12">
    <div #container class="container text-left mt-2 px-5 py-2" (scroll)="rememberScrollPosition($event)">

      <div *ngIf="!canManage">
        <div class="row">
          <ng-container *ngFor="let section of currentGrant.grantDetails.sections">
              <div *ngIf="action === getCleanText(section.sectionName)" [disabled]="true">
                <h4>
                    {{section.sectionName.toLocaleUpperCase()}}
                  </h4>
                <ng-container *ngFor="let attribute of section.attributes">
                  <ng-container *ngIf="attribute.fieldType==='string' || attribute.fieldType==='multiline'">
                    <b>{{attribute.fieldName}}</b>
                    <div>{{attribute.fieldValue}}</div>
                  </ng-container>
                  <mat-nav-list>
                    <ng-container *ngIf="attribute.fieldType==='document'">
                      <mat-list-item>
                        <mat-icon mat-list-icon>attachment</mat-icon>
                        <a mat-tab-link mat-line target="_blank"
                           [href]="'/api/public/grants/'+currentGrant.id+'/file/'+attribute.fieldName">
                          {{attribute.fieldName}}
                        </a>
                      </mat-list-item>
                    </ng-container>
                  </mat-nav-list>
                </ng-container>
              </div>
          </ng-container>
        </div>
        <hr>
      </div>
      <!--MANAGEMENT SECTION-->
      <div *ngIf="canManage">

        <div class="row">
          <div class="col-12">

          <ng-container *ngFor="let section of currentGrant.grantDetails.sections">
              <div *ngIf="action === getCleanText(section.sectionName)">
                
                <div class="row">
                  <div class="col-10">
                    <mat-form-field>
                      <input [(ngModel)]="section.sectionName" [ngModelOptions]="{standAlone:true}"
                                     (ngModelChange)="checkGrant($event)"
                                     matInput placeholder="Section Name" class="anu-input">
                    </mat-form-field>
                  </div>
                  <div class="col-2 text-right" style="display: flex;align-items: center;justify-content: flex-start;">
                    
                    <a class="mr-2 text-gray" 
                       (click)="confirm(section.id,0,[],0,'section','section')"><i
                            class="fa fa-trash"></i></a>
                    <a (click)="addNewFieldToSection(section.id,section.sectionName)"
                       class="mr-2 text-gray"><i class="fa fa-plus-square"></i></a>
                  </div>
                </div>
                <hr>
                <div>
                  <ng-container #sectionsContainer *ngFor="let attribute of section.attributes">
                    <div class="row mb-4 mt-2" style="border-left: solid #d4d4d4; box-shadow: 0px 2px 13px #d4d4d4; padding: 20px; background: #f4f4f4;">
                      <ng-container class="mb-2">
                        <div class="col-sm-4 col-lg-8" *ngIf="attribute.fieldType==='multiline'">
                          <mat-form-field>

                            <input id="field_{{attribute.id}}" [(ngModel)]="attribute.fieldName" required class="anu-input"
                                   [ngModelOptions]="{standAlone:true}"
                                   (ngModelChange)="checkGrant()"
                                   matInput placeholder="Field Name">
                          </mat-form-field>
                        </div>
                        <div class="col-sm-4 col-lg-4" *ngIf="attribute.fieldType==='text'">
                          <mat-form-field>

                            <input id="field_{{attribute.id}}" [(ngModel)]="attribute.fieldName" required class="anu-input"
                                   [ngModelOptions]="{standAlone:true}"
                                   (ngModelChange)="checkGrant()"
                                   matInput placeholder="Field Name">
                          </mat-form-field>
                        </div>
                        <div class="col-sm-4 col-lg-4" *ngIf="attribute.fieldType==='table'">
                          <mat-form-field>

                            <input  id="field_{{attribute.id}}" [(ngModel)]="attribute.fieldName" required class="anu-input"
                                   [ngModelOptions]="{standAlone:true}"
                                   (ngModelChange)="checkGrant()"
                                   matInput placeholder="Field Name">
                          </mat-form-field>
                        </div>
                        <div class="col-sm-4 col-lg-12" *ngIf="attribute.fieldType==='kpi'">
                          <mat-form-field>

                            <input id="field_{{attribute.id}}" [(ngModel)]="attribute.fieldName" required class="anu-input"
                                   [ngModelOptions]="{standAlone:true}"
                                   (ngModelChange)="checkGrant()"
                                   matInput placeholder="KPI Title">
                          </mat-form-field>
                        </div>
                        <div class="col-sm-4 col-lg-4 text-left">
                          <mat-form-field>
                            <mat-label>Type</mat-label>
                            <mat-select [(ngModel)]="attribute.fieldType"  class="anu-input"
                                        [ngModelOptions]="{standAlone:true}"
                                        (ngModelChange)="handleTypeChange($event,attribute)">
                              <mat-option value="none" aria-selected="true">--Select type
                                of field--
                              </mat-option>
                              <mat-option value="multiline">Descriptive</mat-option>
                              <mat-option value="kpi">Measurement/KPI</mat-option>
                              <mat-option value="table">Tablular</mat-option>
                              <!--mat-op
                              <!--mat-op
                              <!--mat-option value="document">Document</mat-option-->
                            </mat-select>

                          </mat-form-field>
                        </div>
                        <div class="col-sm-3 col-lg-3 text-left" *ngIf="attribute.fieldType==='text'">
                          <mat-form-field>
                            <input matInput [(ngModel)]="attribute.fieldValue" class="anu-input"
                                   [required]="attribute.deletable?'required':''"
                                   [ngModelOptions]="{standAlone:true}"
                                   placeholder="Field Value"
                                   (ngModelChange)="checkGrant()">
                          </mat-form-field>
                        </div>
                        <div class="col-sm-12 col-lg-11 text-left" *ngIf="attribute.fieldType==='table'">
                          
                          <button (click)="addColumn(attribute)">Add Column</button>
                          <button (click)="addRow(attribute)">Add Row</button>
                          <div class="row flex-row flex-nowrap" style="overflow: hidden;overflow-x: scroll;">
                          <table>
                            <tr>
                              <td width="20%" style="position: sticky; left: 0; z-index: 1040;background: rgb(244,244,244)">&nbsp;</td>
                            <ng-container *ngFor="let column of attribute.fieldTableValue[0].columns">
                              
                                <td style="border: 1px solid #e4e4e4;">
                                  <mat-form-field>
                                    <input matInput [(ngModel)]="column.name" class="anu-input"
                                           [required]="attribute.deletable?'required':''"
                                           [ngModelOptions]="{standAlone:true}"
                                           placeholder="Column description" 
                                           (ngModelChange)="checkGrant()">
                                  </mat-form-field>
                                </td>
                              
                            </ng-container>
                            </tr>
                            <ng-container *ngFor="let row of attribute.fieldTableValue">
                              <tr>
                                <td width="20%" style="position: sticky; left: 0; z-index: 1040;background: rgb(244,244,244)">
                                  <mat-form-field>
                                    <textarea matInput [(ngModel)]="row.name" class="anu-input"
                                           [required]="attribute.deletable?'required':''"
                                           [ngModelOptions]="{standAlone:true}"
                                           placeholder="Row description" 
                                           (ngModelChange)="checkGrant()"></textarea>
                                  </mat-form-field>
                                </td>
                                <ng-container *ngFor="let column of row.columns">
                                  <td style="border: 1px solid #e4e4e4;">
                                    <mat-form-field>
                                    <input matInput [(ngModel)]="column.value" class="anu-input"
                                           [required]="attribute.deletable?'required':''"
                                           [ngModelOptions]="{standAlone:true}"
                                           placeholder="Value" 
                                           (ngModelChange)="checkGrant()">
                                  </mat-form-field>
                                  </td>
                                </ng-container>
                              </tr>
                            </ng-container>
                          </table>
                        </div>

                        </div>
                        <div class="col-sm-3 col-lg-3 text-left" *ngIf="attribute.fieldType==='kpi'">
                          <mat-form-field>
                            <input matInput [(ngModel)]="attribute.target" class="anu-input"
                                   [required]="attribute.deletable?'required':''"
                                   [ngModelOptions]="{standAlone:true}"
                                   placeholder="Target/Goal"
                                   (ngModelChange)="checkGrant()">
                          </mat-form-field>
                        </div>
                        <div class="col-sm-3 col-lg-3 text-left" *ngIf="attribute.fieldType==='kpi'">
                          <mat-form-field>
                            <mat-label>Reporting Frequency</mat-label>
                            <mat-select [(ngModel)]="attribute.frequency"  class="anu-input"
                                        [ngModelOptions]="{standAlone:true}"
                                        (ngModelChange)="checkGrant()">
                              <mat-option value="none" aria-selected="true">--Select type
                                of field--
                              </mat-option>
                              <mat-option value="monthly">Monthly</mat-option>
                              <mat-option value="quarterly">Quarterly</mat-option>
                              <mat-option value="half-yearly">Half Yearly</mat-option>
                              <mat-option value="yearly">Yearly</mat-option>
                            </mat-select>

                          </mat-form-field>
                        </div>
                        <div class="col-sm-7 col-lg-11 text-left" *ngIf="attribute.fieldType==='multiline'">
                          <textarea [(ngModel)]="attribute.fieldValue" class="anu-input h-100 w-100"
                                   [required]="attribute.deletable?'required':''"
                                   [ngModelOptions]="{standAlone:true}"
                                   (ngModelChange)="checkGrant()"></textarea>
                        </div>
                        <div class="col-sm-1 col-lg-1"
                             style="display: flex;align-items: center;">
                          <mat-icon (click)="confirm(section.id,attribute.id,[],0,'field','field')"
                                    aria-hidden="false"
                                    aria-label="Example home icon" inline="true">
                            delete_outline
                          </mat-icon>
                        </div>
                      </ng-container>
                      <ng-container *ngIf="attribute.fieldType=='document'">
                        <div class="col-sm-7 col-lg-7">
                          <a href="/api/app/grants/{{currentGrant.id}}/file/{{attribute.fieldName}}">
                            <b class="">{{attribute.fieldName}}</b>
                          </a>
                        </div>
                        <div class="col-sm-4 col-lg-4">
                          <mat-form-field>
                            <mat-label>Type</mat-label>
                            <mat-select [(ngModel)]="attribute.fieldType" class="anu-input"
                                        [ngModelOptions]="{standAlone:true}"
                                        (ngModelChange)="checkGrant()">
                              <mat-option value="none" aria-selected="true">--Select type
                                of field--
                              </mat-option>
                              <mat-option value="text">Text</mat-option>
                              <mat-option value="document">Document</mat-option>
                            </mat-select>
                          </mat-form-field>
                        </div>
                        <div class="col-sm-1 col-lg-1"
                             style="display: flex;align-items: center;">
                          <mat-icon (click)="deleteFieldEntry()" aria-hidden="false"
                                    aria-label="Example home icon" inline="true">
                            delete_outline
                          </mat-icon>
                        </div>
                      </ng-container>
                    </div>
                  </ng-container>
                </div>
              </div>
          </ng-container>
        </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div #editFieldModal class="modal fade" id="editFieldModal" tabindex="-1" role="dialog"
     aria-labelledby="exampleModalLabel" aria-hidden="true">
  <input type="text" id="editFieldIdHolder">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editFieldLabel"></h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <input id="editFieldInput" class="form-control" value="">
      </div>
      <div class="">
        <button type="button" class="btn btn-primary pull-right"
                (click)="saveField()">Okay
        </button>
        <button type="button" class="btn btn-link pull-right" data-dismiss="modal">Close</button>

      </div>
    </div>
  </div>
</div>

<div #createFieldModal class="modal fade" id="createFieldModal" tabindex="-1" role="dialog"
     aria-labelledby="exampleModalLabel" aria-hidden="true">
  <input type="text" id="sectionIdHolder">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="createFieldLabel"></h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="fieldTitleInput" class="mat-form-field-label pull-left">Field Name:</label>
          <input id="fieldTitleInput" class="form-control" value="">
        </div>
        <label for="fieldValueInput" class="mat-form-field-label pull-left">Field Type:</label>
        <select id="fieldValueInput" class="form-control">
          <option value="string" selected>Text</option>
          <option value="string">Document</option>
        </select>
      </div>
      <div class="">
        <button type="button" class="btn btn-primary pull-right"
                (click)="addField()">Okay
        </button>
        <button type="button" class="btn btn-link pull-right" data-dismiss="modal">Close</button>

      </div>
    </div>
  </div>
</div>

<div #createSectionModal class="modal fade" id="createSectionModal" tabindex="-1" role="dialog"
     aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="createSectionLabel"></h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="fieldTitleInput" class="mat-form-field-label pull-left">Section Name:</label>
          <input id="sectionTitleInput" class="form-control" value="">
        </div>
      </div>
      <div class="">
        <button type="button" class="btn btn-primary pull-right"
                (click)="saveSection()">Done
        </button>
        <button type="button" class="btn btn-warning pull-right"
                (click)="saveSectionAndAddNew()">Save & Add New Section
        </button>
        <button type="button" class="btn btn-link pull-right" data-dismiss="modal">Close</button>

      </div>
    </div>
  </div>
</div>


<div #createKpiModal id="createKpiModal" class="modal fade" tabindex="-1"
     role="dialog"
     aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="createReportingPeriodLabel">Add new KPI</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-sm-12">
            <mat-form-field>
              <input matInput id="kpiDescription" #kpiDescriptionElem class="form-control"
                     placeholder="KPI description">
            </mat-form-field>
          </div>
          <div class="col-sm-12 text-left">
            <div id="reporting-data">Select what you want to be reported for this KPI</div>
            <mat-radio-group class="reporting-data-radio-group" aria-labelledby="reporting-data"
                             (change)="setKpiTypeSection($event)">
              <mat-radio-button checked class="reporting-data-radio-button" value="Quantitative">Numbers
                and Metrics
              </mat-radio-button>
              <mat-radio-button class="reporting-data-radio-button" value="Qualitative">Long Responses
              </mat-radio-button>
              <mat-radio-button class="reporting-data-radio-button" value="Document">Document
                Attachments
              </mat-radio-button>
            </mat-radio-group>
          </div>
          <div class="col-sm-12 text-left" *ngIf="currentKPIType==='Quantitative'">
            <div id="kpi-type">Select the type KPI type</div>
            <mat-radio-group class="reporting-data-radio-group" aria-labelledby="kpi-type"
                             (change)="setKpiReportingTypeSection($event)">
              <mat-radio-button class="reporting-data-radio-button" checked value="activity">Monitoring
                and Evaluation
              </mat-radio-button>
              <mat-radio-button class="reporting-data-radio-button" value="financial">Financial
              </mat-radio-button>
            </mat-radio-group>
          </div>
        </div>
      </div>
      <div class="">
        <button type="button" class="btn btn-primary pull-right"
                (click)="saveKpi()">Done
        </button>
        <!--<button type="button" class="btn btn-warning pull-right"
                (click)="saveKpiAndAddNew()">Save & Add New KPI
        </button>-->
        <button type="button" class="btn btn-link pull-right" data-dismiss="modal">Close</button>

      </div>
    </div>
  </div>
</div>


<div #selectScheduleModal id="selectScheduleModal" class="modal fade" tabindex="-1"
     role="dialog"
     aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="createReportingPeriodLabel">Select Grant Schedule</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <mat-select [(ngModel)]="schedule" [ngModelOptions]="{standAlone: true}">
          <mat-option value="1">Monthly</mat-option>
          <mat-option value="3">Quarterly</mat-option>
          <mat-option value="6">Half Yearly</mat-option>
          <mat-option value="12">Yearly</mat-option>
        </mat-select>
      </div>
      <div class="">
        <button type="button" class="btn btn-primary pull-right"
                (click)="saveKpi()">Done
        </button>
        <!--<button type="button" class="btn btn-warning pull-right"
                (click)="saveKpiAndAddNew()">Save & Add New KPI
        </button>-->
        <button type="button" class="btn btn-link pull-right" data-dismiss="modal">Close</button>

      </div>
    </div>
  </div>
</div>



